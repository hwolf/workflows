name: Build
on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
        description: Deploy to environment?
      service-folder:
        type: string
        default: '.'
      sonar-token:
        type: string

jobs:
  build:
    name: 'Build'
    uses: hwolf/workflows/.github/workflows/build-and-test.yml@main
    with:
      publish-image: ${{ inputs.environment != 'none' }}
      sonar-token: ${{ inputs.sonar-token }}

  terraform:
    name: 'Validate Terraform'
    uses: hwolf/workflows/.github/workflows/verify-terraform.yml@main

  deploy:
    name: 'Deploy'
    if: inputs.environment != 'none'
    needs:
      - build
      - terraform
    uses: hwolf/workflows/.github/workflows/deploy.yml@main
    with:
      image-name: "${{ needs.build.outputs.image-name }}"
      environment: "${{ inputs.environment }}"
